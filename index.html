<script>
(function(){
  function boot(){
    try{
      const CONFIG = {
        bookCallURL: "https://calendly.com/calendar-labham/finterval",
        saveBestScore: true
      };

      // wire bottom CTA (About section)
      const bc = document.getElementById('bookCallBottom');
      if (bc) bc.href = CONFIG.bookCallURL;

      // categories
      const CATS = [
        { id: 'basics', label: 'Basics' },
        { id: 'invest', label: 'Investing' },
        { id: 'tax',    label: 'Tax & Jargon' },
        { id: 'india',  label: 'India Context' },
      ];
      const catList = document.getElementById('catList');
      CATS.forEach(c => {
        const id = `cat_${c.id}`;
        const w = document.createElement('label');
        w.className = 'pill';
        w.style.display = 'flex';
        w.style.alignItems = 'center';
        w.style.gap = '8px';
        w.style.padding = '8px 10px';
        w.innerHTML = `<input type="checkbox" id="${id}" checked aria-label="${c.label} category"/> <span>${c.label}</span>`;
        catList.appendChild(w);
      });

      // small local fallback bank (used only if AI hiccups)
      const BANK = [
        {id:1, cat:'basics', difficulty:'Easy', q:'What does SIP stand for in mutual funds?', options:['Systematic Investment Plan','Savings & Insurance Plan','Secure Income Portfolio','Scheduled Investment Period'], answer:0, explain:'SIP = Systematic Investment Plan: you invest a fixed amount at regular intervals.'},
        {id:2, cat:'basics', difficulty:'Easy', q:'NAV in mutual funds refers to…', options:['Net Asset Value per unit','Net Annual Variation','Nominal Asset Value','Normalized Average Value'], answer:0, explain:'NAV is the per-unit market value of a mutual fund after accounting for expenses.'},
        {id:3, cat:'invest', difficulty:'Easy', q:'ELSS funds typically have a mandatory lock-in of:', options:['1 year','3 years','5 years','No lock-in'], answer:1, explain:'ELSS has a 3-year lock-in.'},
      ];

      // state
      const QUESTION_TIME = 20; // seconds per question
      const BATCH_SIZE = 10;    // fetch this many AI questions at a time
      let play = { list: [], idx: 0, score: 0, correct: 0, streak: 0, answered: false, asked: 0, timerId: null };

      // dom
      const qEl = document.getElementById('question');
      const cEl = document.getElementById('choices');
      const eEl = document.getElementById('explain');
      const nextBtn = document.getElementById('nextBtn');
      const retryBtn = document.getElementById('retryBtn');
      const qCategory = document.getElementById('qCategory');
      const qDifficulty = document.getElementById('qDifficulty');
      const aiStatus = document.getElementById('aiStatus');
      const tsec = document.getElementById('tsec');
      const tbar = document.getElementById('tbar');

      const scoreNow = document.getElementById('scoreNow');
      const correctNow = document.getElementById('correctNow');
      const streakNow = document.getElementById('streakNow');
      document.getElementById('year').textContent = new Date().getFullYear();

      // best score badge
      const BEST_KEY = 'finterval_best';
      function updateBestBadge(){
        const best = localStorage.getItem(BEST_KEY);
        document.getElementById('bestBadge').textContent = `Best FinScore: ${best ? best : '—'}`;
      }
      updateBestBadge();

      function setAIStatus(s){ if(aiStatus) aiStatus.textContent = `AI: ${s}`; }
      const shuffle = arr => arr.map(v=>[Math.random(),v]).sort((a,b)=>a[0]-b[0]).map(v=>v[1]);
      function selectedCategories(){ return CATS.filter(c => document.getElementById(`cat_${c.id}`).checked).map(c=>c.id); }
      function pickQuestions(total){
        const cats = new Set(selectedCategories());
        let pool = BANK.filter(q => cats.has(q.cat));
        if(pool.length === 0) pool = BANK;
        return shuffle(pool).slice(0,total);
      }

      // your Apps Script URL
      const BACKEND_URL = "https://script.google.com/macros/s/AKfycbwqZyaWQ1pH9e5US0h69mSccgI2jneLkcwDGwe6Csrj9DbYva8gKevGn9oiLxDgnbQh/exec";
      async function generateWithAI(total){
        if(!BACKEND_URL){ setAIStatus('Not set'); return pickQuestions(total); }
        setAIStatus('Connecting…');
        let txt='';
        try{
          const r = await fetch(BACKEND_URL, { method:'POST', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({ total }) });
          if(!r.ok){ setAIStatus('HTTP '+r.status); return pickQuestions(total); }
          txt = await r.text();
        }catch(e){ console.error('AI fetch error', e); setAIStatus('Error'); return pickQuestions(total); }

        let s = (txt||'').trim();
        if(s.startsWith('```')) s = s.replace(/^```(?:json)?/i,'').replace(/```$/,'').trim();
        let out=null;
        try{
          const first = JSON.parse(s);
          out = Array.isArray(first) ? first : (typeof first==='string' && first.trim().startsWith('[') ? JSON.parse(first) : null);
        }catch{
          const m = s.match(/\[[\s\S]*\]/); if(m){ try{ out = JSON.parse(m[0]); }catch{} }
        }
        if(!Array.isArray(out) || out.length===0){ setAIStatus('Empty'); return pickQuestions(total); }
        setAIStatus('OK');
        return out.map((x,i)=>({ id:9000+i, cat:x.cat||'basics', difficulty:x.difficulty||'Easy', q:String(x.q||''), options:(Array.isArray(x.options)? x.options.slice(0,4).map(String):[]), answer:(Number.isInteger(x.answer)? x.answer:0), explain:String(x.explain||'') }));
      }

      async function ensureBuffer(min=3){
        const remaining = play.list.length - play.idx - 1;
        if(remaining < min){
          const batch = await generateWithAI(BATCH_SIZE);
          play.list = play.list.concat(batch);
        }
      }

      function reset(){
        play.idx = 0; play.score=0; play.correct=0; play.streak=0; play.answered=false; play.asked=0; play.list=[];
        scoreNow.textContent = 0; correctNow.textContent = 0; streakNow.textContent = 0;
        eEl.classList.add('hidden'); eEl.textContent='';
        nextBtn.disabled = true; retryBtn.classList.add('hidden');
      }

      async function start(){
        reset();
        await ensureBuffer(10);
        render();
      }

      function startTimer(){
        stopTimer();
        let left = QUESTION_TIME; tsec.textContent = left; tbar.style.width = '100%';
        play.timerId = setInterval(() => {
          left -= 0.1; // update every 100ms
          if(left <= 0){ left = 0; tsec.textContent = 0; tbar.style.width = '0%'; stopTimer(); timeUp(); return; }
          tsec.textContent = Math.ceil(left);
          tbar.style.width = `${(left/QUESTION_TIME)*100}%`;
        }, 100);
      }
      function stopTimer(){ if(play.timerId){ clearInterval(play.timerId); play.timerId=null; } }

      function render(){
        const q = play.list[play.idx];
        if(!q){ qEl.textContent='Loading…'; nextBtn.disabled=true; return; }
        qEl.textContent = q.q;
        qCategory.textContent = `Category: ${q.cat||'—'}`;
        qDifficulty.textContent = `Level: ${q.difficulty||'—'}`;
        cEl.innerHTML = '';
        eEl.classList.add('hidden'); eEl.textContent='';
        nextBtn.disabled = true; play.answered=false;

        q.options.forEach((opt, i) => {
          const btn = document.createElement('button');
          btn.className = 'choice';
          btn.innerHTML = `<span class="key">${String.fromCharCode(65+i)}</span><span>${opt}</span>`;
          btn.addEventListener('click', () => handleAnswer(i));
          cEl.appendChild(btn);
        });

        startTimer();
      }

      function handleAnswer(i){
        if(play.answered) return; play.answered = true; stopTimer();
        const q = play.list[play.idx];
        const nodes = Array.from(cEl.children);
        nodes.forEach((btn, idx) => {
          btn.disabled = true;
          if(idx === q.answer){ btn.classList.add('correct'); }
          if(idx === i && i !== q.answer){ btn.classList.add('incorrect'); }
        });
        const ok = i === q.answer;
        if(ok){ play.correct++; play.streak++; play.score += 10 + Math.min(20, play.streak*2); eEl.className='explain ok'; }
        else { play.streak=0; eEl.className='explain err'; }
        eEl.innerHTML = `<strong>${ok ? 'Correct!' : 'Not quite.'}</strong> ${q.explain}`;
        eEl.classList.remove('hidden');
        play.asked++;
        correctNow.textContent = play.correct; streakNow.textContent = play.streak; scoreNow.textContent = play.score;
        nextBtn.disabled = false;
      }

      function timeUp(){
        if(play.answered) return; play.answered = true;
        const q = play.list[play.idx];
        Array.from(cEl.children).forEach((btn, idx) => { btn.disabled = true; if(idx === q.answer){ btn.classList.add('correct'); } });
        play.streak = 0; eEl.className='explain err';
        eEl.innerHTML = `<strong>Time’s up!</strong> ${q.explain}`;
        eEl.classList.remove('hidden');
        play.asked++; nextBtn.disabled = false; stopTimer();
      }

      document.getElementById('nextBtn').addEventListener('click', async () => {
        play.idx++;
        await ensureBuffer(3);
        render();
      });

      document.getElementById('retryBtn').addEventListener('click', start);

      document.getElementById('shareBtn').onclick = async () => {
        const pct = play.asked ? Math.round((play.correct/play.asked)*100) : 0;
        const shareText = `I’m playing Finterval by Labham — FinScore: ${play.score} (${pct}% correct). Try it!`;
        try{
          if(navigator.share){ await navigator.share({title:'Finterval – Labham', text: shareText}); }
          else { await navigator.clipboard.writeText(shareText); alert('Result copied!'); }
        }catch(e){ }
      };

      // go!
      start();
    }catch(err){
      console.error('Finterval boot error:', err);
      const qEl = document.getElementById('question'); if(qEl){ qEl.textContent = 'There was a loading error. Please tap Restart.'; }
    }
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', boot);} else { boot(); }
})();
</script>
